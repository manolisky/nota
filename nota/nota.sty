% Nota Package: A system for including formatted music scores in LaTeX.
\ProvidesPackage{nota}[2025/08/19 v1.0 Nota Package]

\makeatletter

\RequirePackage{kvoptions}
\SetupKeyvalOptions{family=nota, prefix=nota@}

\DeclareStringOption[6.875]{unit} % default = 1.0 (stores as string)
\DeclareStringOption[Leipzig]{font}

\ProcessKeyvalOptions*

\RequirePackage{graphicx}
\RequirePackage{pdfpages}

% Add our generated scores directory to the graphics path
\graphicspath{{\jobname-notaaux/}}

% --- File Handling ---
% We create a new file handle to write our score requests to.
\newwrite\nota@scoresfile

% --- Counters ---
% We use a counter to give each score a unique ID.
\newcounter{nota@score}

% --- Macro Definitions ---
% This is the main macro that does the work. It's internal.
% It checks if the score files have been generated.

\newcommand{\nota@render}[3]{% 
    % #1: score type (inline, fullscore, example)
    % #2: score options (the code inside the TeX command)
    % #3: the MEI file path

    % get current dimmensions
    \newdimen\notapaperwidth
    \notapaperwidth=\paperwidth

    \newdimen\notapaperheight
    \notapaperheight=\paperheight

    \newdimen\notatopmargin
    \notatopmargin=\dimexpr1in+\topmargin+\headheight+\headsep\relax

    \newdimen\notabottommargin
    \notabottommargin=\dimexpr\paperheight-(1in+\topmargin+\headheight+\headsep+\textheight)\relax

    \newdimen\notaleftmargin
    \notaleftmargin=\dimexpr1in+\oddsidemargin\relax

    \newdimen\notarightmargin
    \notarightmargin=\dimexpr\paperwidth-(1in+\oddsidemargin+\textwidth)\relax

    % Increment the unique ID for each score encountered.
    \stepcounter{nota@score}%

    % Check if the final .tex include file exists.
    \IfFileExists{\jobname-notaaux/nota-score-\the\value{nota@score}.tex}
    {% 
        % --- SECOND PASS: The file exists, so we can include it. ---
        \begingroup
            #2 % Apply the formatting options
            \input{\jobname-notaaux/nota-score-\the\value{nota@score}.tex}
        \endgroup
    }% 
    {% 
        % --- FIRST PASS: The file does not exist. Write a request. ---
        % We capture the CURRENT layout values at this point in the document.
        % Format: ID|TYPE|PATH|PAGEWIDTH|PAGEHEIGHT|TOPMARGIN|BOTTOMMARGIN|ODDSIDEMARGIN|EVENSIDEMARGIN
        \immediate\write\nota@scoresfile{\the\value{nota@score}|#1|#3|% 
            \nota@font|%
            \nota@unit|%
            \the\notapaperwidth|%
            \the\notapaperheight|%
            \the\notatopmargin|%
            \the\notabottommargin|%
            \the\notarightmargin|%
            \the\notaleftmargin%
        }%
        % And print a placeholder in the document.
        \texttt{[Nota: Score \the\value{nota@score} processing...] }% 
    }% 
}

% --- User-Facing Commands ---
% These are the commands you will use in your document.

\newcommand{\includescore}[1]{%
    \vspace{5ex}
    \raggedbottom% before-code
    \nota@render{inline}{% 
        \centering
        \setlength{\parskip}{1ex plus 5ex}
        \setlength{\parindent}{0mm}% 
        \flushbottom
    }{#1}% 
    \raggedbottom% after-code
    \vspace{5ex}
}

% Command that renders full pdf score and imports it

\newcommand{\fullscore}[1]{% 
    \nota@render{fullscore}{
        \setlength{\parindent}{0mm}%
    }{#1}% 
    \vspace{5ex}
}

\newcommand{\examplescore}[1]{% 
    \nota@render{example}{
        \setlength{\parindent}{0mm}% 
    }{#1}% 
}

% --- Document Hooks ---
% These commands run automatically at the start and end of the document.

\AtBeginDocument{% 
    % Before the document starts, open the .scores.aux file for writing.
    \immediate\openout\nota@scoresfile=\jobname.scores.aux
}

\AtEndDocument{% 
    % At the end of the document, close the file.
    \immediate\closeout\nota@scoresfile
}

\makeatother

\endinput
%% End of nota.sty